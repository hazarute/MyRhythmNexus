name: Package per-customer release

on:
  workflow_dispatch:
    inputs:
      exe_path:
        description: 'Path to built exe (relative to repo root)'
        required: true
        default: 'dist/MyRhythmNexus.exe'
      customers:
        description: 'JSON array of customer objects (e.g. [{"name":"acme","backend":"https://acme/api/v1"}])'
        required: true
        default: '[]'

jobs:
  package:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up PowerShell
        uses: PowerShell/PowerShell@v4

      - name: Create packages
        shell: pwsh
        run: |
          $exe = "${{ github.event.inputs.exe_path }}"
          $customers = ConvertFrom-Json '${{ github.event.inputs.customers }}'
          foreach ($c in $customers) {
            Write-Host "Packaging $($c.name) -> $($c.backend)"
            .\tools\package_customer.ps1 -ExePath $exe -BackendUrl $c.backend -CustomerName $c.name -OutputDir "release"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packaged-releases
          path: release/**
